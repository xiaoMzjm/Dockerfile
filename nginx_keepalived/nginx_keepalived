#step 1：更新源并下载依赖包
FROM index.alauda.cn/library/ubuntu/realnginx:v4.0

MAINTAINER zjm "383248689@qq.com"

RUN sourcesPath="/etc/apt/sources.list" && \
    mv $sourcesPath $sourcesPath.backup && \
    touch $sourcesPath && \
    echo "deb http://mirrors.163.com/ubuntu/ trusty main restricted universe multiverse" >> $sourcesPath && \
    echo "deb http://mirrors.163.com/ubuntu/ trusty-security main restricted universe multiverse" >> $sourcesPath && \
    echo "deb http://mirrors.163.com/ubuntu/ trusty-updates main restricted universe multiverse" >> $sourcesPath && \
    echo "deb http://mirrors.163.com/ubuntu/ trusty-proposed main restricted universe multiverse" >> $sourcesPath && \
    echo "deb http://mirrors.163.com/ubuntu/ trusty-backports main restricted universe multiverse" >> $sourcesPath && \
    echo "deb-src http://mirrors.163.com/ubuntu/ trusty main restricted universe multiverse" >> $sourcesPath && \
    echo "deb-src http://mirrors.163.com/ubuntu/ trusty-security main restricted universe multiverse" >> $sourcesPath && \
    echo "deb-src http://mirrors.163.com/ubuntu/ trusty-updates main restricted universe multiverse" >> $sourcesPath && \
    echo "deb-src http://mirrors.163.com/ubuntu/ trusty-proposed main restricted universe multiverse" >> $sourcesPath && \
    echo "deb-src http://mirrors.163.com/ubuntu/ trusty-backports main restricted universe multiverse" >> $sourcesPath && \
    apt-get update && \
    apt-get install -y wget && apt-get install -y gcc && apt-get install -y openssl && apt-get install -y libssl-dev && apt-get install -y libpopt-dev && apt-get install -y make && apt-get install -y daemon

#step 2：下载并编译安装keepalived
RUN mkdir -p /usr/local/src/keepalived/ && \
    wget http://120.52.72.41/www.keepalived.org/c3pr90ntcsf0/software/keepalived-1.2.19.tar.gz -O /usr/local/src/keepalived/keepalived-1.2.19.tar.gz && \
    cd /usr/local/src/keepalived/ && \
    tar -zxvf keepalived-1.2.19.tar.gz && \
    cd keepalived-1.2.19 && \
    mkdir -p /usr/local/keepalived && \
    ./configure --prefix=/usr/local/keepalived && \
    make && \
    make install && \
    rm -rf /usr/local/src/keepalived/

#step 3：添加keepalived称为服务
RUN cp /usr/local/keepalived/sbin/keepalived /usr/sbin/ && \
    cp /usr/local/keepalived/etc/rc.d/init.d/keepalived /etc/init.d/ && \
    mkdir -p /etc/sysconfig/ && \
    cp /usr/local/keepalived/etc/sysconfig/keepalived /etc/sysconfig/ && \
    mkdir -p /etc/rc.d/init.d && \
    cp /usr/share/initramfs-tools/scripts/functions /etc/rc.d/init.d/ && \
    sed -i 's/daemon keepalived/#daemon keepalived/' /etc/init.d/keepalived && \
    sed -i '/#daemon keepalived/a\daemon keepalived start' /etc/init.d/keepalived && \
    mkdir /var/lock/subsys

COPY keepalived.conf /etc/keepalived/

#step 4：安装mail服务
RUN apt-get install -y mutt msmtp && \
    echo "set sendmail="/usr/bin/msmtp"" >> /etc/Muttrc && \
    echo "set use_from=yes" >> /etc/Muttrc && \
    echo "set realname="zjm"" >> /etc/Muttrc && \
    echo "set from=383248689@qq.com" >> /etc/Muttrc && \
    echo "set envelope_from=yes" >> /etc/Muttrc && \
    touch ~/.msmtprc && \
    touch ~/.msmtprc && \
    echo "account default" >> ~/.msmtprc && \
    echo "host smtp.qq.com" >> ~/.msmtprc && \
    echo "from 383248689@qq.com" >> ~/.msmtprc && \
    echo "auth plain" >> ~/.msmtprc && \
    echo "user 383248689@qq.com" >> ~/.msmtprc && \
    echo "password tpbehbdlukwmbjcd" >> ~/.msmtprc && \
    echo "logfile ~/.msmtp.log" >> ~/.msmtprc

#step 5：配置mail服务
RUN mkdir -p /home/keepalived_sh && \
    touch /home/keepalived_sh/keepalivedStatus.sh && \
    touch /home/keepalived_sh/serverDown.sh && \
    touch /home/keepalived_sh/serverUp.sh && \
    chmod +x /home/keepalived_sh/keepalivedStatus.sh && \
    chmod +x /home/keepalived_sh/serverDown.sh && \
    chmod +x /home/keepalived_sh/serverUp.sh && \
    echo "echo \"\$1 \$2 \$3\" | mutt -s \"keepalived notify\" heijueerror@163.com" >> /home/keepalived_sh/keepalivedStatus.sh && \
    echo "echo \"\$1\" | mutt -s \"keepalived notify\" heijueerror@163.com" >> /home/keepalived_sh/serverUp.sh && \
    echo "pkill keepalived" >> /home/keepalived_sh/serverDown.sh && \
    echo "/etc/init.d/networking restart" >> /home/keepalived_sh/serverDown.sh && \
    echo "echo \"\$1\" | mutt -s \"keepalived notify\" heijueerror@163.com" >> /home/keepalived_sh/serverDown.sh